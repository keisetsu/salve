<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: formats.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/mangalam.css">
</head>

<body>


<div id="main">

    <h1 class="page-title">Source: formats.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @module formats
 * @desc This module contains data and utilities to work with the
 * schema format that salve uses natively.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */
define(/** @lends module:formats */ function (require, exports, module) {
'use strict';

var util = require("./util");
var inherit = require("./oop").inherit;
var patterns = require("./patterns");
var pro = patterns.__protected;

//
// MODIFICATIONS TO THIS TABLE MUST BE REFLECTED IN rng-to-js.xsl
//
var name_to_constructor = {
    // Array = 0 is hard-coded elsewhere in the conversion code so don't
    // change it.
    0: Array,
    Empty: pro.Empty,
    1: pro.Empty,
    Data: pro.Data,
    2: pro.Data,
    List: pro.List,
    3: pro.List,
    Param: pro.Param,
    4: pro.Param,
    Value: pro.Value,
    5: pro.Value,
    NotAllowed: pro.NotAllowed,
    6: pro.NotAllowed,
    Text: pro.Text,
    7: pro.Text,
    Ref: pro.Ref,
    8: pro.Ref,
    OneOrMore: pro.OneOrMore,
    9: pro.OneOrMore,
    Choice: pro.Choice,
    10: pro.Choice,
    Group: pro.Group,
    11: pro.Group,
    Attribute: pro.Attribute,
    12: pro.Attribute,
    Element: pro.Element,
    13: pro.Element,
    Define: pro.Define,
    14: pro.Define,
    Grammar: pro.Grammar,
    15: pro.Grammar,
    EName: pro.EName,
    16: pro.EName
};


//
// MODIFICATIONS TO THESE VARIABLES MUST BE REFLECTED IN rng-to-js.xsl
//

// This is a bit field
var OPTION_NO_PATHS = 1;
// var OPTION_WHATEVER = 2;
// var OPTION_WHATEVER_PLUS_1 = 4;
// etc...


/**
 * Resolves an array according to format V0. For each element, if the
 * element is an array, it is resolved. If the element is an object,
 * then the object is constructed. Otherwise, the element remains as
 * is.
 *
 * @private
 * @param {Array} arr The array to resolve.
 */
function _resolveArray(arr) {
    for (var el_ix = 0, el; (el = arr[el_ix]) !== undefined; el_ix++) {
        if (el instanceof Array)
            _resolveArray(el);
        else if (typeof el === "object")
            arr[el_ix] = _constructObject(el);
        // else leave as is
    }
}

/**
 * Applies a constructor.
 *
 * @private
 * @param {Function} ctor The constructor to apply.
 * @param {Array} args The arguments to pass to the constructor.
 * @returns {Object} An object created by the constructor.
 */
function _applyConstructor(ctor, args) {
    var new_obj = Object.create(ctor.prototype);
    var ctor_ret = ctor.apply(new_obj, args);

    // Some constructors return a value; make sure to use it!
    return ctor_ret !== undefined ? ctor_ret: new_obj;
}

/**
 * Constructs an object according to format V0. In effect, converts
 * the Object created from the JSON representation to a JavaScript
 * Object of the proper class.
 *
 * @private
 * @param {Object} obj The object read from the JSON string.
 * @returns {Object} An object of the proper class.
 * @throws {Error} If the object is malformed, or has a type unknown
 * to salve.
 */
function _constructObject(obj) {
    var type = obj.type;
    if (type === undefined)
        throw new Error("object without type: " + obj);

    var ctor = name_to_constructor[type];
    if (ctor === undefined)
        throw new Error("undefined type: " + type);

    // It is possible to have objects without argument list.
    var args = obj.args;
    if (args !== undefined)
        _resolveArray(args);

    return _applyConstructor(ctor, args);
}

/**
 * A class for walking the JSON object representing a schema.
 *
 * @private
 * @constructor
 * @param {Object} options The options object from the file that
 * contains the schema.
 */
function V1JSONWalker(options) {
    this.options = options;
}

/**
 * Walks a V1 representation of a JavaScript object.
 *
 * @private
 * @param {Array} array The array representing the object.
 * @throws {Error} If the object is malformed.
 * @returns {Object} The return value of {@link
 * module:formats~V1JSONWalker#_processObject _processObject}.
 */
V1JSONWalker.prototype.walkObject = function(array) {
    if (array.length &lt; 1)
        throw new Error("array too small to contain object");

    var type = array[0];
    if (type === undefined)
        throw new Error("object without type: " + util.inspec(array));

    var ctor = name_to_constructor[type];
    if (ctor === undefined)
        throw new Error("undefined type: " + type);

    if (ctor === Array)
        throw new Error("trying to build array with _constructObjectV1");

    var add_path = (this.options & OPTION_NO_PATHS) && ctor !== pro.EName;

    var args;
    if (array.length > 1) {
        args = array.slice(1);
        if (add_path)
            args.unshift("");
        args.unshift(0);
        args = this._processArrayForCtor(args);
    }
    else if (add_path)
        args = [""];
    else
        args = [];

    return this._processObject(array, ctor, args);
};

/**
 * Processes an object. Derived classes will want to override this
 * method to perform their work.
 *
 * @param {Array} array The object represented as an array.
 * @param {Function} ctor The object's constructor.
 * @param {Array} args The arguments that should be passed to the
 * constructor.
 * @returns {Object|undefined} If the &lt;code>V1JSONWalker&lt;/code>
 * instance is meant to convert the JSON data, then this method should
 * return an Object. If the &lt;code>V1JSONWalker&lt;/code> instance is
 * meant to check the JSON data, then it should return
 * &lt;code>undefined&lt;/code>.
 */
V1JSONWalker.prototype._processObject = function(array, ctor, args) {
    return undefined; // Do nothing
};

/**
 * Process an array so that it can be used by a constructor.
 *
 * @private
 * @param {Array} arr The array to resolve.
 * @throws {Error} If the array is malformed.
 * @returns {Array} The processed array.
 */
V1JSONWalker.prototype._processArrayForCtor = function (arr) {
    // Drop the array type indicator.
    return this._walkArray(arr).slice(1);
};


/**
 * Resolve an array according to format V1. For each element, if the
 * element is an array, it is resolved. If the element is an object,
 * then the object is constructed. Otherwise, the element remains as
 * is.
 *
 * @private
 * @param {Array} arr The array to resolve.
 * @throws {Error} If the array is malformed.
 * @returns {Array} The processed array.
 */
V1JSONWalker.prototype._processArray = function (arr) {
    // Drop the array type indicator.
    return this._walkArray(arr).slice(1);
};

V1JSONWalker.prototype._walkArray = function (arr) {
    if (arr[0] !== 0)
        throw new Error("array type not 0, but " + arr[0] +
                        " for array " + arr);

    var ret = [0];
    for (var el_ix = 1, el; (el = arr[el_ix]) !== undefined; el_ix++) {
        if (el instanceof Array) {
            if (el[0] !== 0)
                ret.push(this.walkObject(el));
            else
                ret.push(this._processArray(el));
        }
        else
            ret.push(el);
    }
    return ret;
};

/**
 * A JSON walker that constructs a pattern tree as it walks the JSON
 * object.
 *
 * @private
 * @extends module:formats~V1JSONWalker
 */
function V1Constructor() {
    V1JSONWalker.apply(this, arguments);
}
inherit(V1Constructor, V1JSONWalker);

V1Constructor.prototype._processObject = function (array, ctor, args) {
    return _applyConstructor(ctor, args);
};

//
// MODIFICATIONS TO THIS FUNCTION MUST BE REFLECTED IN rng-to-js.xsl
//
/**
 * Constructs a tree of patterns from a JSON representation of a RNG
 * schema. This representation must have been created by simplifying
 * the original RNG and then converting it with the
 * &lt;code>rng-to-js.xsl&lt;/code> transformation provided with salve.
 *
 * @param {string} code The JSON representation.
 * @throws {Error} When the version of the JSON representation is not
 * supported.
 * @returns {module:validate~Pattern} The tree.
 */
function constructTree(code) {
    var parsed = JSON.parse(code);
    if (typeof(parsed) === 'object' && !parsed.v) {
        return _constructObject(parsed);
    }
    else {
        var version = parsed.v;
        var options = parsed.o;
        if (version === 1)
            return new V1Constructor(options).walkObject(parsed.d, options);
        else
            throw new Error("unknown version: " + version);
    }
}

exports.constructTree = constructTree;

//
// Exports which are meant for other modules internal to salve.
//
// DO NOT USE THIS OUTSIDE SALVE! THIS EXPORT MAY CHANGE AT ANY TIME!
// YOU'VE BEEN WARNED!
//
exports.__protected = {
    V1JSONWalker: V1JSONWalker,
    name_to_constructor: name_to_constructor,
    OPTION_NO_PATHS: OPTION_NO_PATHS
};

});

//  LocalWords:  MPL util oop rng js xsl JSON constructObjectV
//  LocalWords:  JSONWalker RNG
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-formats.html">formats</a></li><li><a href="module-hashstructs.html">hashstructs</a></li><li><a href="module-name_resolver.html">name_resolver</a></li><li><a href="module-oop.html">oop</a></li><li><a href="module-patterns.html">patterns</a></li><li><a href="module-set.html">set</a></li><li><a href="module-util.html">util</a></li><li><a href="module-validate.html">validate</a></li></ul><h3>Classes</h3><ul><li><a href="module-formats-V1JSONWalker.html">formats~V1JSONWalker</a></li><li><a href="module-hashstructs-HashBase.html">hashstructs~HashBase</a></li><li><a href="module-hashstructs-HashMap.html">hashstructs~HashMap</a></li><li><a href="module-hashstructs-HashSet.html">hashstructs~HashSet</a></li><li><a href="module-name_resolver-NameResolver.html">name_resolver~NameResolver</a></li><li><a href="module-patterns-Attribute.html">patterns~Attribute</a></li><li><a href="module-patterns-AttributeNameError.html">patterns~AttributeNameError</a></li><li><a href="module-patterns-AttributeValueError.html">patterns~AttributeValueError</a></li><li><a href="module-patterns-AttributeWalker.html">patterns~AttributeWalker</a></li><li><a href="module-patterns-Choice.html">patterns~Choice</a></li><li><a href="module-patterns-ChoiceError.html">patterns~ChoiceError</a></li><li><a href="module-patterns-ChoiceWalker.html">patterns~ChoiceWalker</a></li><li><a href="module-patterns-Define.html">patterns~Define</a></li><li><a href="module-patterns-DefineWalker.html">patterns~DefineWalker</a></li><li><a href="module-patterns-DisallowedElementWalker.html">patterns~DisallowedElementWalker</a></li><li><a href="module-patterns-Element.html">patterns~Element</a></li><li><a href="module-patterns-ElementNameError.html">patterns~ElementNameError</a></li><li><a href="module-patterns-ElementWalker.html">patterns~ElementWalker</a></li><li><a href="module-patterns-Empty.html">patterns~Empty</a></li><li><a href="module-patterns-EmptyWalker.html">patterns~EmptyWalker</a></li><li><a href="module-patterns-EName.html">patterns~EName</a></li><li><a href="module-patterns-Event.html">patterns~Event</a></li><li><a href="module-patterns-Grammar.html">patterns~Grammar</a></li><li><a href="module-patterns-GrammarWalker.html">patterns~GrammarWalker</a></li><li><a href="module-patterns-Group.html">patterns~Group</a></li><li><a href="module-patterns-GroupWalker.html">patterns~GroupWalker</a></li><li><a href="module-patterns-NoSubwalker.html">patterns~NoSubwalker</a></li><li><a href="module-patterns-NotAllowed.html">patterns~NotAllowed</a></li><li><a href="module-patterns-OneOrMore.html">patterns~OneOrMore</a></li><li><a href="module-patterns-OneOrMoreWalker.html">patterns~OneOrMoreWalker</a></li><li><a href="module-patterns-Pattern.html">patterns~Pattern</a></li><li><a href="module-patterns-PatternOnePattern.html">patterns~PatternOnePattern</a></li><li><a href="module-patterns-PatternTwoPatterns.html">patterns~PatternTwoPatterns</a></li><li><a href="module-patterns-Ref.html">patterns~Ref</a></li><li><a href="module-patterns-ReferenceError.html">patterns~ReferenceError</a></li><li><a href="module-patterns-RefWalker.html">patterns~RefWalker</a></li><li><a href="module-patterns-SingleNameError.html">patterns~SingleNameError</a></li><li><a href="module-patterns-SingleSubwalker.html">patterns~SingleSubwalker</a></li><li><a href="module-patterns-Text.html">patterns~Text</a></li><li><a href="module-patterns-TextWalker.html">patterns~TextWalker</a></li><li><a href="module-patterns-ValidationError.html">patterns~ValidationError</a></li><li><a href="module-patterns-Walker.html">patterns~Walker</a></li><li><a href="module-set-Set.html">set~Set</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Thu Dec 12 2013 18:26:48 GMT-0600 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
